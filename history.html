<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account History - Snowy Market Gen</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        :root {
            --bg-color: #0c0f17;
            --card-bg: #1a1f2e;
            --accent-color: #9d4edd;
            --accent-gradient: linear-gradient(45deg, #7160e8, #9d4edd);
            --text-primary: #ffffff;
            --text-secondary: #a0a7b8;
            --border-color: rgba(255, 255, 255, 0.05);
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            line-height: 1.5;
        }
        
        .navbar {
            background-color: rgba(15, 20, 30, 0.9);
            backdrop-filter: blur(10px);
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 20px;
            color: var(--accent-color);
        }
        
        .navbar-logo i {
            font-size: 24px;
        }
        
        .navbar-links {
            display: flex;
            gap: 15px;
        }
        
        .navbar-links a, .navbar-links button {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        
        .navbar-links a:hover, .navbar-links button:hover {
            color: var(--text-primary);
            background: rgba(157, 78, 221, 0.1);
        }
        
        .navbar-links .active {
            color: var(--text-primary);
            background: rgba(157, 78, 221, 0.15);
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-header {
            padding: 20px 0;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .page-header h1 {
            font-size: 28px;
            margin: 0;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .page-header h1 i {
            color: var(--accent-color);
        }
        
        /* User Card */
        .user-card {
            background: rgba(26, 31, 46, 0.6);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .user-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-gradient);
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            background: var(--accent-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .user-details {
            flex: 1;
        }
        
        .username {
            margin: 0 0 5px 0;
            font-size: 20px;
            color: var(--text-primary);
        }
        
        .tier-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            color: white;
        }
        
        .tier-premium {
            background: linear-gradient(45deg, #f5b014, #ff8a00);
        }
        
        .tier-free {
            background: #555;
        }
        
        /* Actions Bar */
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
            position: sticky;
            top: 70px;
            z-index: 90;
            background: rgba(12, 15, 23, 0.9);
            padding: 15px 0;
            backdrop-filter: blur(10px);
        }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: none;
            border-radius: 8px;
            background: rgba(30, 35, 50, 0.5);
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent-gradient);
            color: white;
        }
        
        .btn-secondary {
            background: rgba(30, 35, 50, 0.5);
            color: var(--text-secondary);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* Account Cards */
        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .account-card {
            background: rgba(26, 31, 46, 0.7);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .account-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            border-color: rgba(157, 78, 221, 0.3);
        }
        
        .service-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            color: var(--accent-color);
            font-size: 16px;
        }
        
        .account-service {
            color: var(--accent-color);
            font-weight: 600;
            margin: 0 0 10px 0;
            font-size: 16px;
            text-transform: capitalize;
        }
        
        .account-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .account-detail:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .detail-value {
            color: var(--text-primary);
            font-size: 13px;
            font-family: 'Courier New', monospace;
            background: rgba(15, 20, 30, 0.4);
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 5px;
            max-width: 160px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .copy-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            font-size: 12px;
            transition: color 0.2s;
        }
        
        .copy-btn:hover {
            color: var(--accent-color);
        }
        
        .copy-both-btn {
            margin-top: auto;
            width: 100%;
            margin-top: 15px;
            background: rgba(157, 78, 221, 0.15);
            color: var(--accent-color);
            border: 1px solid rgba(157, 78, 221, 0.3);
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .copy-both-btn:hover {
            background: rgba(157, 78, 221, 0.25);
            transform: translateY(-2px);
        }
        
        .plan-info {
            font-size: 12px;
            font-style: italic;
            color: #9d9fa7;
        }
        
        .time-info {
            font-size: 12px;
            color: #9d9fa7;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background: rgba(26, 31, 46, 0.3);
            border-radius: 10px;
            border: 1px dashed rgba(255, 255, 255, 0.1);
        }
        
        .empty-state i {
            font-size: 40px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            color: var(--text-primary);
            margin: 0 0 10px 0;
            font-size: 18px;
        }
        
        .empty-state p {
            color: var(--text-secondary);
            margin: 0;
            font-size: 14px;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 30px;
        }
        
        .page-btn {
            background: rgba(30, 35, 50, 0.5);
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .page-btn:hover {
            background: rgba(157, 78, 221, 0.2);
            color: var(--text-primary);
        }
        
        .page-btn.active {
            background: var(--accent-gradient);
            color: white;
        }
        
        .page-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* Export Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        /* Ensure the modal is centered */
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            padding: 25px;
            position: relative;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            margin: 0;
            font-size: 20px;
            color: var(--text-primary);
        }
        
        .close-modal {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close-modal:hover {
            color: var(--accent-color);
        }
        
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .export-option {
            background: rgba(30, 35, 50, 0.5);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        
        .export-option:hover {
            background: rgba(30, 35, 50, 0.8);
            border-color: rgba(157, 78, 221, 0.3);
        }
        
        .export-icon {
            width: 40px;
            height: 40px;
            background: rgba(157, 78, 221, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-color);
            font-size: 18px;
            margin-right: 15px;
        }
        
        .export-info {
            flex: 1;
        }
        
        .export-info h4 {
            margin: 0 0 5px 0;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .export-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(26, 31, 46, 0.9);
            border-left: 4px solid var(--accent-color);
            padding: 12px 20px;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification i {
            color: var(--accent-color);
            font-size: 18px;
        }
        
        .notification-message {
            color: var(--text-primary);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-logo">
            <i class="fas fa-snowflake"></i>
            Snowy Market Gen
        </div>
        <div class="navbar-links">
            <a href="index.html"><i class="fas fa-home"></i> Home</a>
            <a href="history.html" class="active"><i class="fas fa-history"></i> My Accounts</a>
            <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </nav>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-history"></i> My Generated Accounts</h1>
        </div>
        
        <!-- User Card -->
        <div class="user-card">
            <div class="user-avatar" id="userAvatar">A</div>
            <div class="user-details">
                <h2 class="username" id="usernameDisplay">Username</h2>
                <div>
                    <span id="tierBadge" class="tier-badge tier-premium"><i class="fas fa-crown"></i> Premium</span>
                </div>
            </div>
        </div>
        
        <!-- Actions Bar -->
        <div class="actions-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search accounts...">
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" id="clearHistoryBtn"><i class="fas fa-trash"></i> Clear History</button>
                <button class="btn btn-primary" id="exportBtn"><i class="fas fa-file-export"></i> Export</button>
            </div>
        </div>
        
        <!-- Accounts Grid -->
        <div class="accounts-grid" id="accountsGrid">
            <!-- Account cards will be added here by JavaScript -->
        </div>
        
        <!-- Empty State (displayed when no accounts) -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-history"></i>
            <h3>No Accounts Generated Yet</h3>
            <p>Your generated accounts will appear here.</p>
        </div>
        
        <!-- Pagination -->
        <div class="pagination" id="pagination">
            <!-- Pagination buttons will be added here by JavaScript -->
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Export Accounts</h3>
                <button class="close-modal" id="closeModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="export-options">
                <div class="export-option" id="exportTxt">
                    <div class="export-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="export-info">
                        <h4>Text File (.txt)</h4>
                        <p>Simple format with account details</p>
                    </div>
                </div>
                <div class="export-option" id="exportCsv">
                    <div class="export-icon">
                        <i class="fas fa-file-csv"></i>
                    </div>
                    <div class="export-info">
                        <h4>CSV File (.csv)</h4>
                        <p>Spreadsheet compatible format</p>
                    </div>
                </div>
                <div class="export-option" id="exportJson">
                    <div class="export-icon">
                        <i class="fas fa-file-code"></i>
                    </div>
                    <div class="export-info">
                        <h4>JSON File (.json)</h4>
                        <p>Complete data with all account details</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span class="notification-message" id="notificationMessage">Text copied to clipboard!</span>
    </div>

    <script>
        // Global variables
        let allAccounts = [];
        let filteredAccounts = [];
        let currentPage = 1;
        const accountsPerPage = 8;
        
        // Icons for different account types
        const serviceIcons = {
            'discord': 'fa-discord',
            'netflix': 'fa-film',
            'hulu': 'fa-tv',
            'spotify': 'fa-music',
            'instagram': 'fa-instagram',
            'disney': 'fa-star',
            'hbo': 'fa-video',
            'twitter': 'fa-twitter',
            'facebook': 'fa-facebook',
            'amazon': 'fa-shopping-cart',
            'steam': 'fa-steam',
            'crunchyroll': 'fa-play',
            'minecraft': 'fa-cube',
            'origin': 'fa-gamepad',
            'uplay': 'fa-gamepad',
            'epic': 'fa-gamepad',
            'fortnite': 'fa-gamepad',
            'roblox': 'fa-cube',
            'valorant': 'fa-gamepad',
            'default': 'fa-user'
        };
        
        // DOM Elements
        const accountsGrid = document.getElementById('accountsGrid');
        const emptyState = document.getElementById('emptyState');
        const pagination = document.getElementById('pagination');
        const searchInput = document.getElementById('searchInput');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const exportBtn = document.getElementById('exportBtn');
        const exportModal = document.getElementById('exportModal');
        const closeModal = document.getElementById('closeModal');
        const exportTxt = document.getElementById('exportTxt');
        const exportCsv = document.getElementById('exportCsv');
        const exportJson = document.getElementById('exportJson');
        const notification = document.getElementById('notification');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadAndDisplayAccounts();
            setupEventListeners();
        });
        
        // Load user information from localStorage
        function loadUserInfo() {
            try {
                // Try to get keyauth_info first for most accurate info
                const keyauthData = localStorage.getItem('keyauth_info');
                let username = 'User';
                let tier = 'free';
                
                if (keyauthData) {
                    try {
                        const keyauthJson = JSON.parse(keyauthData);
                        username = keyauthJson.username || 'User';
                        
                        // Check subscriptions to determine tier
                        if (keyauthJson.subscriptions && keyauthJson.subscriptions.length > 0) {
                            // Check if any subscription has 'Premium' in it
                            const premiumSub = keyauthJson.subscriptions.find(sub => 
                                sub.subscription && sub.subscription.toLowerCase().includes('premium'));
                            
                            if (premiumSub) {
                                tier = 'premium';
                            }
                        }
                    } catch (e) {
                        console.warn('Could not parse keyauth_info JSON:', e);
                    }
                } else {
                    // Fallback to auth data if keyauth_info is not available
                    const authData = localStorage.getItem('auth');
                    if (authData) {
                        try {
                            const userData = JSON.parse(authData);
                            username = userData.username || username;
                            tier = userData.tier || tier;
                        } catch (e) {
                            console.warn('Could not parse auth JSON:', e);
                        }
                    } else {
                        // Check license key for tier
                        const licenseKey = localStorage.getItem('license_key');
                        if (licenseKey && !licenseKey.includes('FREE')) {
                            tier = 'premium';
                        }
                    }
                }
                
                // Check is_logged_in flag
                const isLoggedIn = localStorage.getItem('is_logged_in');
                if (!isLoggedIn || isLoggedIn !== 'true') {
                    console.log('User is not logged in according to flag');
                    setDefaultUserInfo();
                    return;
                }
                
                // Update display
                const userAvatar = document.getElementById('userAvatar');
                const usernameDisplay = document.getElementById('usernameDisplay');
                const tierBadge = document.getElementById('tierBadge');
                
                if (userAvatar) {
                    userAvatar.textContent = username.charAt(0).toUpperCase();
                }
                
                if (usernameDisplay) {
                    usernameDisplay.textContent = username;
                }
                
                if (tierBadge) {
                    if (tier.toLowerCase() === 'premium') {
                        tierBadge.className = 'tier-badge tier-premium';
                        tierBadge.innerHTML = '<i class="fas fa-crown"></i> Premium';
                    } else {
                        tierBadge.className = 'tier-badge tier-free';
                        tierBadge.innerHTML = '<i class="fas fa-user"></i> Free';
                    }
                }
                
            } catch (error) {
                console.error('Error loading user info:', error);
                setDefaultUserInfo();
            }
        }
        
        // Set default user info when no auth data is available
        function setDefaultUserInfo() {
            const userAvatar = document.getElementById('userAvatar');
            const usernameDisplay = document.getElementById('usernameDisplay');
            const tierBadge = document.getElementById('tierBadge');
            
            if (userAvatar) {
                userAvatar.textContent = 'G';
            }
            
            if (usernameDisplay) {
                usernameDisplay.textContent = 'Guest';
            }
            
            if (tierBadge) {
                tierBadge.className = 'tier-badge tier-free';
                tierBadge.innerHTML = '<i class="fas fa-user"></i> Guest';
            }
        }
        
        // Load and display accounts
        function loadAndDisplayAccounts() {
            try {
                // Get account history from localStorage
                const historyData = localStorage.getItem('accountHistory');
                
                if (!historyData) {
                    showEmptyState();
                    return;
                }
                
                // Parse history data
                allAccounts = JSON.parse(historyData);
                
                if (!allAccounts || allAccounts.length === 0) {
                    showEmptyState();
                    return;
                }
                
                // Sort accounts by most recent first (assuming there's a timestamp)
                allAccounts.sort((a, b) => {
                    const dateA = a.timestamp ? new Date(a.timestamp) : new Date(0);
                    const dateB = b.timestamp ? new Date(b.timestamp) : new Date(0);
                    return dateB - dateA;
                });
                
                // Apply initial filtering (show all)
                filterAccounts('');
                
            } catch (error) {
                console.error('Error loading account history:', error);
                showEmptyState();
            }
        }
        
        // Filter accounts based on search input
        function filterAccounts(query) {
            query = query.toLowerCase().trim();
            
            if (query === '') {
                filteredAccounts = [...allAccounts];
            } else {
                filteredAccounts = allAccounts.filter(account => {
                    // Search in all account fields
                    return Object.values(account).some(value => {
                        if (typeof value === 'string') {
                            return value.toLowerCase().includes(query);
                        }
                        return false;
                    });
                });
            }
            
            // Reset to first page and display
            currentPage = 1;
            displayAccounts();
            updatePagination();
        }
        
        // Display accounts for the current page
        function displayAccounts() {
            // Clear the grid
            accountsGrid.innerHTML = '';
            
            // Hide empty state if we have accounts
            emptyState.style.display = filteredAccounts.length === 0 ? 'block' : 'none';
            
            if (filteredAccounts.length === 0) {
                // If we have accounts but none match the filter
                if (allAccounts.length > 0) {
                    emptyState.innerHTML = `
                        <i class="fas fa-search"></i>
                        <h3>No Matching Accounts</h3>
                        <p>Try a different search term.</p>
                    `;
                }
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * accountsPerPage;
            const endIndex = Math.min(startIndex + accountsPerPage, filteredAccounts.length);
            const accountsToShow = filteredAccounts.slice(startIndex, endIndex);
            
            // Create account cards
            accountsToShow.forEach(account => {
                const accountCard = createAccountCard(account);
                accountsGrid.appendChild(accountCard);
            });
        }
        
        // Create an account card element
        function createAccountCard(account) {
            const card = document.createElement('div');
            card.className = 'account-card';
            
            // Determine service name and icon
            const serviceName = account.service || account.type || 'Unknown';
            const iconClass = serviceIcons[serviceName.toLowerCase()] || serviceIcons.default;
            
            // Extract password and plan info
            let password = account.password || '';
            let planInfo = '';
            
            // Check if password contains plan info (separated by |)
            if (password.includes(' | Plan:')) {
                const parts = password.split(' | Plan:');
                password = parts[0].trim();
                planInfo = 'Plan: ' + parts[1].trim();
            }
            
            // Get timestamp if available
            let timestamp = '';
            if (account.timestamp || account.time) {
                const timeMs = account.timestamp || account.time;
                const date = new Date(Number(timeMs));
                if (!isNaN(date)) {
                    timestamp = date.toLocaleString();
                }
            }
            
            // Create card content
            card.innerHTML = `
                <div class="service-icon">
                    <i class="fab ${iconClass}"></i>
                </div>
                <h3 class="account-service">${serviceName}</h3>
                <div class="account-detail">
                    <span class="detail-label">Email/Username</span>
                    <div class="detail-value" title="${account.email || account.username || ''}">
                        ${account.email || account.username || 'N/A'}
                        <button class="copy-btn" onclick="copyToClipboard('${account.email || account.username || ''}', this)">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="account-detail">
                    <span class="detail-label">Password</span>
                    <div class="detail-value" title="${password}">
                        ${password || 'N/A'}
                        <button class="copy-btn" onclick="copyToClipboard('${password}', this)">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>`;
                
            // Add plan info if available
            if (planInfo) {
                card.innerHTML += `
                <div class="account-detail">
                    <span class="detail-label">Plan</span>
                    <div class="detail-value plan-info" title="${planInfo}">
                        ${planInfo}
                    </div>
                </div>`;
            }
            
            // Add timestamp if available
            if (timestamp) {
                card.innerHTML += `
                <div class="account-detail">
                    <span class="detail-label">Generated</span>
                    <div class="detail-value time-info">
                        ${timestamp}
                    </div>
                </div>`;
            }
            
            // Add copy email:pass button for easier copying
            const copyBothBtn = document.createElement('button');
            copyBothBtn.className = 'btn btn-secondary copy-both-btn';
            copyBothBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Credentials';
            copyBothBtn.onclick = function() {
                const emailPass = `${account.email || account.username || ''}:${password}`;
                copyToClipboard(emailPass, this);
            };
            card.appendChild(copyBothBtn);
            
            return card;
        }
        
        // Update pagination controls
        function updatePagination() {
            pagination.innerHTML = '';
            
            if (filteredAccounts.length <= accountsPerPage) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            // Calculate total pages
            const totalPages = Math.ceil(filteredAccounts.length / accountsPerPage);
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = `page-btn ${currentPage === 1 ? 'disabled' : ''}`;
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevBtn.disabled = currentPage === 1;
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayAccounts();
                    updatePagination();
                }
            });
            pagination.appendChild(prevBtn);
            
            // Page buttons
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // Adjust if we're at the end
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    displayAccounts();
                    updatePagination();
                });
                pagination.appendChild(pageBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = `page-btn ${currentPage === totalPages ? 'disabled' : ''}`;
            nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayAccounts();
                    updatePagination();
                }
            });
            pagination.appendChild(nextBtn);
        }
        
        // Show empty state
        function showEmptyState() {
            accountsGrid.innerHTML = '';
            emptyState.style.display = 'block';
            pagination.style.display = 'none';
        }
        
        // Copy text to clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                // Change button icon temporarily
                const icon = button.querySelector('i');
                icon.className = 'fas fa-check';
                
                // Show notification
                showNotification('Copied to clipboard!');
                
                // Reset icon after a moment
                setTimeout(() => {
                    icon.className = 'fas fa-copy';
                }, 1500);
            }).catch(err => {
                console.error('Error copying text: ', err);
                showNotification('Failed to copy text', true);
            });
        }
        
        // Show notification
        function showNotification(message, isError = false) {
            const notificationEl = document.getElementById('notification');
            const messageEl = document.getElementById('notificationMessage');
            const icon = notificationEl.querySelector('i');
            
            messageEl.textContent = message;
            
            if (isError) {
                icon.className = 'fas fa-exclamation-circle';
                notificationEl.style.borderLeftColor = '#ff4d4d';
                icon.style.color = '#ff4d4d';
            } else {
                icon.className = 'fas fa-check-circle';
                notificationEl.style.borderLeftColor = '#9d4edd';
                icon.style.color = '#9d4edd';
            }
            
            notificationEl.classList.add('show');
            
            setTimeout(() => {
                notificationEl.classList.remove('show');
            }, 3000);
        }
        
        // Export accounts to file
        function exportAccounts(format) {
            if (allAccounts.length === 0) {
                showNotification('No accounts to export', true);
                return;
            }
            
            let content = '';
            let filename = `snowy-market-accounts-${new Date().toISOString().slice(0, 10)}`;
            let mimeType = '';
            
            switch (format) {
                case 'txt':
                    content = formatAccountsAsTxt(allAccounts);
                    filename += '.txt';
                    mimeType = 'text/plain';
                    break;
                    
                case 'csv':
                    content = formatAccountsAsCsv(allAccounts);
                    filename += '.csv';
                    mimeType = 'text/csv';
                    break;
                    
                case 'json':
                    content = JSON.stringify(allAccounts, null, 2);
                    filename += '.json';
                    mimeType = 'application/json';
                    break;
            }
            
            // Create and trigger download
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Close modal and show notification
            exportModal.classList.remove('show');
            showNotification(`Accounts exported as ${format.toUpperCase()}`);
        }
        
        // Format accounts as TXT
        function formatAccountsAsTxt(accounts) {
            let result = 'SNOWY MARKET ACCOUNT EXPORT\n\n';
            
            accounts.forEach((account, index) => {
                // Extract password and plan
                let password = account.password || 'N/A';
                let planInfo = '';
                
                if (password.includes(' | Plan:')) {
                    const parts = password.split(' | Plan:');
                    password = parts[0].trim();
                    planInfo = parts[1].trim();
                }
                
                // Format timestamp
                let timestamp = 'N/A';
                if (account.timestamp || account.time) {
                    const timeMs = account.timestamp || account.time;
                    const date = new Date(Number(timeMs));
                    if (!isNaN(date)) {
                        timestamp = date.toLocaleString();
                    }
                }
                
                result += `=== ACCOUNT ${index + 1} ===\n`;
                result += `Service: ${account.service || account.type || 'Unknown'}\n`;
                result += `Email/Username: ${account.email || account.username || 'N/A'}\n`;
                result += `Password: ${password}\n`;
                if (planInfo) {
                    result += `Plan: ${planInfo}\n`;
                }
                result += `Generated: ${timestamp}\n`;
                result += '\n';
            });
            
            return result;
        }
        
        // Format accounts as CSV
        function formatAccountsAsCsv(accounts) {
            let result = 'Service,Email/Username,Password,Plan,Generated\n';
            
            accounts.forEach(account => {
                // Extract password and plan
                let password = account.password || 'N/A';
                let planInfo = 'N/A';
                
                if (password.includes(' | Plan:')) {
                    const parts = password.split(' | Plan:');
                    password = parts[0].trim();
                    planInfo = parts[1].trim();
                }
                
                // Format timestamp
                let timestamp = 'N/A';
                if (account.timestamp || account.time) {
                    const timeMs = account.timestamp || account.time;
                    const date = new Date(Number(timeMs));
                    if (!isNaN(date)) {
                        timestamp = date.toLocaleString();
                    }
                }
                
                const service = (account.service || account.type || 'Unknown').replace(/,/g, ' ');
                const email = (account.email || account.username || 'N/A').replace(/,/g, ' ');
                password = password.replace(/,/g, ' ');
                planInfo = planInfo.replace(/,/g, ' ');
                timestamp = timestamp.replace(/,/g, ' ');
                
                result += `${service},${email},${password},${planInfo},${timestamp}\n`;
            });
            
            return result;
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Search input
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterAccounts(this.value);
                });
            }
            
            // Clear history button
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to clear all account history? This cannot be undone.')) {
                        localStorage.removeItem('accountHistory');
                        allAccounts = [];
                        filteredAccounts = [];
                        showEmptyState();
                        showNotification('Account history cleared');
                    }
                });
            }
            
            // Export button
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    exportModal.classList.add('show');
                });
            }
            
            // Close modal button
            if (closeModal) {
                closeModal.addEventListener('click', function() {
                    exportModal.classList.remove('show');
                });
            }
            
            // Export options
            if (exportTxt) {
                exportTxt.addEventListener('click', function() {
                    exportAccounts('txt');
                });
            }
            
            if (exportCsv) {
                exportCsv.addEventListener('click', function() {
                    exportAccounts('csv');
                });
            }
            
            if (exportJson) {
                exportJson.addEventListener('click', function() {
                    exportAccounts('json');
                });
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target === exportModal) {
                    exportModal.classList.remove('show');
                }
            });
            
            // Logout button
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem('auth');
                    window.location.href = 'login.html';
                });
            }
        }
    </script>
</body>
</html>
